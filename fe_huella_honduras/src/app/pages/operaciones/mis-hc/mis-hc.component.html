<div class="container pb-4">
    <h3 class="dash_title">Mis huellas de carbono</h3>

    <mat-tab-group class="mt-4 dash_tab rounded" (selectedTabChange)="onTabChange($event)">
        <mat-tab label="Mis huellas de carbono">
            <div class="d-flex mb-3 form_sm justify-content-end">

                <button mat-stroked-button color="primary" class="button_add me-2" type="button"
                    (click)="redictAccionesMigitacion()" *ngIf="boAnioBaseFinalizado">
                    Mis medidas de mitigación
                </button>
                <button mat-flat-button color="primary" type="button" (click)="openModalRegistro()" class="button_add">
                    <mat-icon svgIcon="ph-regular:plus"></mat-icon>
                    Nueva Huella de carbono
                </button>
            </div>

            <div [hidden]="tPeriodo.filteredData.length === 0">
                <div class="table-responsive">
                    <table mat-table [dataSource]="tPeriodo" matSort class="mat-elevation-z8 shadow-sm border rounded">
                        <tr mat-header-row *matHeaderRowDef="hPeriodos"></tr>
                        <tr mat-row *matRowDef="let row; columns: hPeriodos;"></tr>

                        <ng-container matColumnDef="anio">
                            <th mat-header-cell *matHeaderCellDef class="text-end">Año</th>
                            <td mat-cell *matCellDef="let item" class="text-end">
                                <div class="d-flex align-items-center justify-content-end">
                                    <button mat-icon-button matTooltip="Cambiar año base" color="primary"
                                        style="color: #160b69;" (click)="openModalAnioBase()" *ngIf="item.boAnioBase">
                                        <mat-icon svgIcon="ph-duotone:bookmark"></mat-icon>
                                    </button>
                                    <label>{{ item.nAnio }}</label>
                                </div>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="publico">
                            <th mat-header-cell *matHeaderCellDef class="text-center">¿Es público?</th>
                            <td mat-cell *matCellDef="let item" class="text-center">
                                <mat-slide-toggle [checked]="item.boReportePublico"
                                    (change)="fnEstadoReportePublico(item, $event)"></mat-slide-toggle>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="fecha">
                            <th mat-header-cell *matHeaderCellDef class="text-center">Fecha últ. actualización</th>
                            <td mat-cell *matCellDef="let item" class="text-center">
                                {{ item.sFechaUltimaModificacion }}</td>
                        </ng-container>

                        <ng-container matColumnDef="emisiones">
                            <th mat-header-cell class="text-end" *matHeaderCellDef>Total de emisiones [tCO<sub>2</sub>e]
                            </th>
                            <td mat-cell class="text-end" *matCellDef="let item">
                                <span *ngIf="item.nEstadoPeriodo!== 3" class="italic">

                                    {{formatearComaMiles(item.bdTotalEmisiones)}}</span>
                                <span *ngIf="item.nEstadoPeriodo === 3">
                                    {{formatearComaMiles(item.bdTotalEmisiones)}}</span>
                            </td>
                        </ng-container>
                        <ng-container matColumnDef="ultreconocimiento">
                            <th mat-header-cell *matHeaderCellDef class="text-center">Nivel alcanzado</th>
                            <td mat-cell class="text-center" *matCellDef="let item">
                                <label *ngIf="item.nReconocimientoActual==1">Cuantificación</label>
                                <label *ngIf="item.nReconocimientoActual==2">Reducción</label>
                                <label *ngIf="item.nReconocimientoActual==3">Compensación</label>
                                <label *ngIf="item.nReconocimientoActual==4">Neutralización</label>
                                <label *ngIf="item.nReconocimientoActual==0">Sin reconocimiento</label>

                            </td>
                        </ng-container>

                        <ng-container matColumnDef="estado">
                            <th mat-header-cell *matHeaderCellDef class="text-center">Estado</th>
                            <td mat-cell class="text-center" *matCellDef="let item">{{ item.sEstadoPeriodo }}
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="reconocimientos">
                            <th mat-header-cell class="text-center" *matHeaderCellDef>Postular a reconocimiento
                            <th>

                            <td mat-cell class="text-center" *matCellDef="let item">

                                <button mat-icon-button color="primary" matTooltip="Cuantificación"
                                    style="color: #64756f;" (click)="openReconocimiento(item,1)"
                                    *ngIf="item.nReconocimientoActual < 1 && item.nEstadoPeriodo!=2">
                                    <mat-icon svgIcon="ph-duotone:medal"></mat-icon>
                                </button>
                                <button mat-icon-button color="primary" matTooltip="Reducción"
                                    (click)="openReconocimiento(item,2)" *ngIf="item.nEstadoReduccion==1"
                                    style="color: #64756f;">
                                    <mat-icon svgIcon="ph-duotone:medal"></mat-icon>
                                </button>
                                <button mat-icon-button color="primary" matTooltip="Compensación/Neutralización"
                                    (click)="openReconocimiento(item,3)" *ngIf="item.nEstadoNeutralizacion==1"
                                    style="color: #64756f;">
                                    <mat-icon svgIcon="ph-duotone:medal"></mat-icon>
                                </button>

                                <!--  <button mat-icon-button color="primary" matTooltip="Neutralización"
                                    (click)="openReconocimiento(item,4)" *ngIf="item.nReconocimientoActual < 4"
                                    [ngStyle]="{'color': item.boSegundoReconocimientoActivo ? '#2c0973' : '#646464'}">
                                    <mat-icon svgIcon="ph-duotone:medal"></mat-icon>
                                </button> -->
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="acciones">
                            <th mat-header-cell *matHeaderCellDef class="text-center" style="width: 170px;">Acciones
                            </th>
                            <td mat-cell *matCellDef="let item" class="text-center">

                                <button mat-icon-button style="color: #60929e" matTooltip="Límites de informe"
                                    (click)="redictLimitesInforme(item)">
                                    <mat-icon *ngIf="item.nEstadoPeriodo == 2 || item.nEstadoPeriodo == 3"
                                        svgIcon="ph-duotone:cards"></mat-icon>
                                    <mat-icon *ngIf="!(item.nEstadoPeriodo == 2 || item.nEstadoPeriodo == 3)"
                                        svgIcon="ph-duotone:pencil-simple"></mat-icon>
                                </button>
                                <button mat-icon-button color="primary" matTooltip="Descargar reporte de huella" *ngIf="item.liReporteGEI && item.liReporteGEI.length > 0 && 
                                (item.nEstadoPeriodo == 2 || item.nEstadoPeriodo == 3)" style="color: #136934;"
                                    (click)="fnDescargaArchivo(item)">
                                    <mat-icon svgIcon="ph-duotone:file-arrow-down"></mat-icon>
                                </button>
                                <button mat-icon-button style="color: #3a19b5" matTooltip="Solicitar reapertura de año"
                                    (click)="openModalReapertura(item)"
                                    *ngIf="item.nEstadoPeriodo == 3  && !item.boProcesoReapertura">
                                    <mat-icon svgIcon="ph-duotone:lock-simple-open"></mat-icon>
                                </button>

                                <button *ngIf="item.nEstadoPeriodo==0" mat-icon-button style="color: #822195"
                                    matTooltip="Eliminar" (click)="eliminarPeriodo(item)">
                                    <mat-icon svgIcon="ph-duotone:trash"></mat-icon>
                                </button>
                            </td>
                        </ng-container>
                    </table>

                </div>
                <mat-paginator class="mt-3" #paginatorHuellas [length]="tPeriodo.filteredData.length" [pageSize]="10"
                    [pageSizeOptions]="[5, 10, 25, 100]"></mat-paginator>
            </div>

            <p class="text-center my-5 fs-20" *ngIf="tPeriodo.data.length > 0 && tPeriodo.filteredData.length === 0">
                No existen resultados para "<span class="truncated-text">{{ filtro }}</span>"
            </p>

            <p class="text-center my-5 fs-20" *ngIf="tPeriodo.data.length === 0">No existen resultados</p>
        </mat-tab>
        <mat-tab label="Mis reconocimientos">
            <div class="d-flex flex-column flex-md-row mb-3 form_sm justify-content-between align-items-start">
                <mat-form-field class="w_organizacion" appearance="outline">
                    <mat-label>Buscar por año</mat-label>
                    <input matInput [(ngModel)]="filtroAnio" (ngModelChange)="aplicarFiltro()" type="text" maxlength="4"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '');" />
                </mat-form-field>
            </div>

            <div class="table-responsive" [hidden]="tReconocimientos.data.length === 0">
                <table mat-table [dataSource]="tReconocimientos" matSort
                    class="mat-elevation-z8 shadow-sm border rounded">
                    <tr mat-header-row *matHeaderRowDef="hReconocimientos"></tr>
                    <tr mat-row *matRowDef="let row; columns: hReconocimientos;"></tr>

                    <ng-container matColumnDef="anio">
                        <th mat-header-cell *matHeaderCellDef class="text-end">Año</th>
                        <td mat-cell *matCellDef="let item" class="text-end">{{ item.oPeriodo.nAnio }}</td>
                    </ng-container>

                    <ng-container matColumnDef="fechaRegistro">
                        <th mat-header-cell *matHeaderCellDef class="text-center">Fecha de registro</th>
                        <td mat-cell *matCellDef="let item" class="text-center">{{ item.sFechaPostulacion }}</td>
                    </ng-container>

                    <ng-container matColumnDef="nivelReconocimiento">
                        <th mat-header-cell *matHeaderCellDef class="text-center">Nivel de reconocimiento</th>
                        <td mat-cell *matCellDef="let item" class="text-center">{{ item.sReconocimiento }}</td>
                    </ng-container>

                    <ng-container matColumnDef="estado">
                        <th mat-header-cell *matHeaderCellDef class="text-center">Estado</th>
                        <td mat-cell *matCellDef="let item" class="text-center">{{ item.sEstado }}</td>
                    </ng-container>

                    <ng-container matColumnDef="acciones">
                        <th mat-header-cell *matHeaderCellDef class="text-center" style="width: 170px;">Acciones</th>
                        <td mat-cell *matCellDef="let item" class="text-center">
                            <button mat-icon-button color="primary" matTooltip="Ver observación"
                                (click)="openModalObservacion(item)" *ngIf="item.nEstado==1" style="color: #bf9f21">
                                <mat-icon svgIcon="ph-duotone:eye"></mat-icon>
                            </button>
                            <button mat-icon-button style="color: #60929e" matTooltip="Editar"
                                *ngIf="item.sCodReconocimiento!='CUAN' && item.nEstado==1"
                                (click)="openRequisitos(item)">
                                <mat-icon svgIcon="ph-duotone:pencil-simple"></mat-icon>
                            </button>
                            <button (click)="fnDescargaReconocimiento(item)" mat-icon-button color="primary"
                                matTooltip="Certificado" *ngIf="item.oDocReconocimiento.sCodigoDocumento"
                                style="color: #0b7221">
                                <mat-icon svgIcon="ph-duotone:file-arrow-down"></mat-icon>
                            </button>
                            <button (click)="fnDescargaDiploma(item)" mat-icon-button color="primary"
                                matTooltip="Descargar diploma de reconocimiento" *ngIf="item.nEstado==2"
                                style="color: #0d6efd">
                                <mat-icon svgIcon="ph-duotone:certificate"></mat-icon>
                            </button>
                        </td>
                    </ng-container>
                </table>


            </div>

            <mat-paginator #paginatorReconocimientos [length]="tReconocimientos.data.length" class="mt-3"
                [pageSize]="10" [pageSizeOptions]="[5, 10, 25, 100]"
                [hidden]="tReconocimientos.data.length === 0"></mat-paginator>

            <p class="text-center my-5 fs-20" style="background-color: white;"
                *ngIf="tReconocimientos.data.length === 0 && filtroAnio">
                No existen resultados para "<span class="truncated-text">{{ filtroAnio }}</span>".
            </p>

            <p class="text-center my-5 fs-20" style="background-color: white;"
                *ngIf="tReconocimientos.data.length === 0 && !filtroAnio">
                No existen resultados
            </p>

        </mat-tab>
    </mat-tab-group>
</div>

<!-- Modal reapertura -->
<ng-template #modalReapertura>
    <div class="dialog-container d-flex flex-column align-items-center text-center">
        <h2 mat-dialog-title class="fw-500 pluto_normal">
            Solicitar reapertura de huella de carbono
            <button mat-icon-button mat-dialog-close class="close-button">
                <mat-icon>close</mat-icon>
            </button>
        </h2>
        <div mat-dialog-content style="width: 95%;">
            <form [formGroup]="formReapertura">
                <mat-form-field appearance="outline" class="mt-2">
                    <mat-label>Ingresar motivo de reapertura</mat-label>
                    <textarea style="resize: none;" matInput formControlName="motivo" rows="6" maxlength="500"
                        oninput="this.value = this.value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ0-9 ,.:]/g, '');"></textarea>
                    <mat-error *ngIf="formReapertura.controls['motivo'].hasError('maxlength')">
                        Máximo 500 caracteres permitidos.
                    </mat-error>
                </mat-form-field>

                <div class="d-flex justify-content-start mt-2">
                    <mat-icon style="width: 38px" class="me-1" svgIcon="ph-regular:info"></mat-icon>

                    <label class="text-start">Al aperturar un periodo, perderá los reconocimientos obtenidos en dicho
                        periodo y deberá volver a
                        postular al sistema de reconocimiento.</label>
                </div>

            </form>
        </div>
        <div mat-dialog-actions>
            <button mat-button mat-dialog-close>Cancelar</button>
            <button mat-flat-button type="submit" color="primary" [disabled]="formReapertura.invalid || loadingModal"
                (click)="fnSolicitarReapertura()">
                <mat-icon *ngIf="loadingModal"><mat-spinner color="primary" diameter="16"></mat-spinner></mat-icon>
                Enviar
            </button>
        </div>
    </div>
</ng-template>

<!-- Modal metodología -->
<ng-template #modalMetodologia>
    <div class="dialog-container d-flex flex-column align-items-center text-center"></div>
    <h2 mat-dialog-title class="fw-500 fs-20 text-center pluto_normal">Confirmación
        <button mat-icon-button mat-dialog-close class="close-button" (click)="fnCerrarModal()">
            <mat-icon>close</mat-icon>
        </button>
    </h2>
    <mat-dialog-content>
        <div mat-dialog-content class="form_sm form_modal pt-0">
            <p>Existen nuevos factores de emisión
                <label class="fw-600 fc-black">{{sNombreNuevaMetodologia}}</label>.
            </p>
            <p>¿Desea mantener su línea base (usar factores de la metodología anterior) o actualizar su
                año base con el año a registrar <label
                    class="fw-600 fc-black">{{formMetodologia.controls['nAnio'].value}}</label>?.</p>
        </div>
    </mat-dialog-content>
    <div mat-dialog-actions class="dialog-container align-self-center">
        <button mat-flat-button type="submit" color="primary" [disabled]="loadingModal"
            (click)="fnRegistrarHuella(true)">
            <mat-icon *ngIf="loadingModal"><mat-spinner color="primary" diameter="16"></mat-spinner></mat-icon>
            Actualizar mi año base
        </button>
        <button mat-flat-button type="submit" color="primary" [disabled]="loadingModal"
            (click)="fnRegistrarHuella(false)">
            <mat-icon *ngIf="loadingModal"><mat-spinner color="primary" diameter="16"></mat-spinner></mat-icon>
            Mantener mi línea actual
        </button>
    </div>
</ng-template>

<!-- Modal registrar -->
<ng-template #modalRegistro>
    <form [formGroup]="formRegistro" (ngSubmit)="fnValidarMetodologia()">
        <h2 mat-dialog-title class="fw-500 fs-20 text-center pluto_normal">Registrar huella de carbono
            <button mat-icon-button mat-dialog-close type="button" class="close-button" (click)="fnCerrarModal()">
                <mat-icon>close</mat-icon>
            </button>
        </h2>
        <mat-dialog-content class="form_sm form_modal">
            <!-- Alerta -->
            <div class="mb-4" *ngIf="boDocumentoInvalido">
                <app-alert [msgError]="sDocumentoInvalido"></app-alert>
            </div>
            <div class="d-flex justify-content-center">
                <mat-form-field class="mt-2" appearance="outline" style="width: 50%;">
                    <mat-label>Año</mat-label>
                    <input matInput formControlName="nAnio" maxlength="4"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </mat-form-field>
            </div>
            <mat-checkbox formControlName="boPublico" #checkbox>
                {{checkbox.checked ? 'Deseo que mi reporte de huella de carbono sea público' :
                'No deseo que mi reporte de huella de carbono sea público' }}
            </mat-checkbox>
        </mat-dialog-content>
        <div mat-dialog-actions class="dialog-container align-self-center">
            <button mat-button mat-dialog-close type="button">Cancelar</button>
            <button mat-flat-button type="submit" color="primary" [disabled]="loadingModal">
                <mat-icon *ngIf="loadingModal"><mat-spinner color="primary" diameter="16"></mat-spinner></mat-icon>
                Guardar
            </button>
        </div>
    </form>
</ng-template>


<!-- Modal año base -->
<ng-template #modalCambioAnioBase>
    <h2 mat-dialog-title class="fw-500 fs-20 text-center pluto_normal">
        Actualizar año base
        <button mat-icon-button mat-dialog-close type="button" class="close-button">
            <mat-icon>close</mat-icon>
        </button>
    </h2>
    <div class="dialog-container d-flex flex-column align-items-center text-center">
        <div mat-dialog-content style="width: 95%;" class="pt-0">
            <p class="text-start">Año base actual: <label class="fw-600 fc-black">{{nAnioBase}}</label> <br>
                Seleccione el nuevo año base e ingrese el motivo del cambio.
            </p>
            <form [formGroup]="formAnioBase">
                <mat-chip-listbox class="chip-list" formControlName="nIdPeriodo">
                    <mat-chip-option class="mat-chip-option" *ngFor="let item of lstPeriodoDisponible"
                        [value]="item.nIdPeriodo">
                        {{ item.nAnio }}
                    </mat-chip-option>
                </mat-chip-listbox>
                <mat-form-field appearance="outline" class="mt-2">
                    <mat-label>Ingresar motivo del cambio</mat-label>
                    <textarea style="resize: none;" matInput formControlName="motivo" rows="4" maxlength="500"
                        oninput="this.value = this.value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ0-9 ,.:\n]/g, '');"></textarea>
                    <mat-error *ngIf="formAnioBase.controls['motivo'].hasError('maxlength')">
                        Máximo 500 caracteres permitidos.
                    </mat-error>
                </mat-form-field>
            </form>
        </div>
        <div mat-dialog-actions>
            <button mat-button mat-dialog-close type="button">Cancelar</button>
            <button mat-flat-button type="submit" color="primary" [disabled]="formAnioBase.invalid || loadingModal"
                (click)="fnCambioAnioBase()">
                <mat-icon *ngIf="loadingModal"><mat-spinner color="primary" diameter="16"></mat-spinner></mat-icon>
                Cambiar
            </button>
        </div>
    </div>
</ng-template>

<!-- Modal cuantificación -->
<ng-template #modalCuantificacion>
    <h2 mat-dialog-title class="fw-500 pluto_normal text-center">
        Nivel de cuantificación
        <button mat-icon-button mat-dialog-close class="close-button">
            <mat-icon>close</mat-icon>
        </button>
    </h2>
    <div class=" text-center">
        <div mat-dialog-content class="pt-0">
            <p>Para postular al nivel de <span class="fc-black fw-500">cuantificación</span>, debe completar los datos
                de actividad de su huella de carbono.</p>
        </div>
        <div mat-dialog-actions>
            <button [disabled]="loadingModal" mat-flat-button mat-dialog-close type="submit" color="primary">
                <mat-icon *ngIf="loadingModal"><mat-spinner color="primary" diameter="16"></mat-spinner></mat-icon>
                Aceptar
            </button>
        </div>
    </div>
</ng-template>

<!-- Modal reducción -->
<ng-template #modalReduccion>
    <h2 mat-dialog-title class="fw-500 pluto_normal text-center">
        Nivel de reducción
        <button mat-icon-button mat-dialog-close class="close-button">
            <mat-icon>close</mat-icon>
        </button>
    </h2>

    <div mat-dialog-content class="text-start pt-0">
        <p>Para postular al nivel de <span class="fc-black fw-500">reducción</span>, debe cumplir con los siguientes
            requisitos:</p>
        <mat-checkbox disabled [checked]="modal_aniobase.nEstadoPeriodo==3">Finalizar la huella del año
            base</mat-checkbox>
        <mat-checkbox disabled [checked]="modal.nReconocimientoActual==1">Obtener nivel de <span
                class="fw-500">Cuantificación</span> en el año de
            postulación.</mat-checkbox>

        <mat-checkbox disabled [checked]="modal_aniobase.boTieneIndicador">Seleccionar indicador en año
            base</mat-checkbox>
        <mat-checkbox disabled [checked]="modal.boTieneIndicador">Seleccionar indicador en año de
            postulación</mat-checkbox>

        <mat-checkbox disabled [checked]="modal.bdReduccion>0">Registrar acciones de mitigación</mat-checkbox>
    </div>

    <div mat-dialog-actions>
        <button [disabled]="loadingModal" mat-flat-button mat-dialog-close type="submit" color="primary">
            <mat-icon *ngIf="loadingModal"><mat-spinner color="primary" diameter="16"></mat-spinner></mat-icon>
            Aceptar
        </button>
    </div>
</ng-template>


<!-- Modal actualizar año base -->
<ng-template #modalActualizarAnioBase>

    <form [formGroup]="formActualizarAnioBase" (ngSubmit)="fnCambioAnioActuBase()">

        <h2 mat-dialog-title class="fw-500 pluto_normal text-center">
            Actualizar año base
            <button mat-icon-button mat-dialog-close class="close-button" type="button">
                <mat-icon>close</mat-icon>
            </button>
        </h2>

        <div mat-dialog-content class="text-start pt-0">
            <p>Para postular al nivel de <span class="fc-black fw-500">reducción</span>, debe actualizar su año base
                seleccionando uno de los propuestos:</p>

            <mat-chip-listbox class="chip-list" formControlName="nIdPeriodo">
                <mat-chip-option class="mat-chip-option" *ngFor="let item of modal.liPeriodosValidos"
                    style="height: 55px;" [value]="item.nIdPeriodo">
                    <span>
                        {{ item.bdTotalEmisiones ?? 0 }} [tCO<sub>2</sub>e]<br>
                        {{ item.nAnio }}
                    </span>
                </mat-chip-option>
            </mat-chip-listbox>

        </div>

        <div mat-dialog-actions>
            <button mat-button mat-dialog-close type="button">Cancelar</button>
            <button [disabled]="formActualizarAnioBase.invalid || loadingModal" mat-flat-button mat-dialog-close
                type="submit" color="primary">
                <mat-icon *ngIf="loadingModal"><mat-spinner color="primary" diameter="16"></mat-spinner></mat-icon>
                Actualizar
            </button>
        </div>

    </form>
</ng-template>


<!-- Modal compensación - neutralización -->
<ng-template #modalCompensacion>
    <h2 mat-dialog-title class="fw-500 pluto_normal text-center">
        Nivel de compensación / neutralización
        <button mat-icon-button mat-dialog-close class="close-button">
            <mat-icon>close</mat-icon>
        </button>
    </h2>
    <div mat-dialog-content class="text-start pt-0">

        <p>Para postular al nivel de <span class="fc-black fw-500">compensación</span> o <span
                class="fc-black fw-500">neutralización</span>, debe obtener el
            reconocimiento de <span class="fc-black fw-500">reducción</span> en el año de postulación.</p>

    </div>
    <div mat-dialog-actions>

        <button [disabled]="loadingModal" mat-flat-button mat-dialog-close type="submit" color="primary">
            <mat-icon *ngIf="loadingModal"><mat-spinner color="primary" diameter="16"></mat-spinner></mat-icon>
            Aceptar
        </button>

    </div>
</ng-template>

<!-- Modal requisitos reducción -->
<ng-template #modalReqPostular>
    <h2 mat-dialog-title class="fw-500 pluto_normal text-center">Nivel de reducción
        <button mat-icon-button mat-dialog-close class="close-button">
            <mat-icon>close</mat-icon>
        </button>
    </h2>
    <mat-dialog-content>
        <div class="row">
            <p class="text-center fc-black fw-500 fs-17">Certificado de verificación</p>
            <div class="col-md-6">
                <p class="text-center">Año base:<span class="fc-black fw-600">{{modal_aniobase.nAnio}}</span></p>
                <input accept=".pdf" type="file" id="fileLineaBase" (change)="onFileChange($event, 'fileLineaBase')"
                    style="display: none;">
                <!-- [disabled]="modal_aniobase.oVerificacion != null" -->
                <label [ngClass]="{'dragging': draggingLineaBase}" for="fileLineaBase" class="solicitud_file"
                    (dragleave)="draggingLineaBase = false" (dragover)="handleDragOver($event, 'fileLineaBase')"
                    (drop)="handleDrop($event, 'fileLineaBase')">
                    <mat-icon *ngIf="!draggingLineaBase && !isUploadedLineaBase" aria-hidden="false"
                        aria-label="cloud_upload" fontIcon="cloud_upload"
                        style="font-size: 32px; height: 32px; width: 32px;"></mat-icon>
                    <mat-icon *ngIf="draggingLineaBase" aria-hidden="false" aria-label="cloud_download"
                        fontIcon="cloud_download" style="font-size: 32px; height: 32px; width: 32px;"></mat-icon>
                    <mat-icon *ngIf="isUploadedLineaBase && !draggingLineaBase" aria-hidden="false"
                        aria-label="check_circle" fontIcon="check_circle"
                        style="font-size: 32px; height: 32px; width: 32px;"></mat-icon>
                    <div *ngIf="!draggingLineaBase && !isUploadedLineaBase" class="solicitud_file--text mt-1">
                        Seleccione para cargar o arrastrar y soltar aquí
                        <br>
                        <span class="mt-3">Archivo permitido en PDF y máximo de 5 mb</span>
                    </div>
                    <div *ngIf="isUploadedLineaBase && !draggingLineaBase" class="mt-1">
                        <span class="solicitud_file--archivo fs-14">Archivo: {{ nombreArchivoLineaBase }}</span>
                    </div>
                    <span *ngIf="draggingLineaBase" class="solicitud_file--text mt-1">Soltar archivo</span>
                </label>

                <!-- Descarga de documento -->
                <div class="d-flex justify-content-center mt-2">
                    <a class="text-primary text-decoration-underline pointer" (click)="fnDescargaCertificado(1)">
                        <span *ngIf="modal_aniobase.oVerificacion != null; else elseDescarga">
                            Descargar: {{ modal_aniobase.oVerificacion.sNombre }}
                        </span>
                        <ng-template #elseDescarga>
                            <span *ngIf="oReduccion.oPeriodo.oVerificacion.sCodigoDocumento">
                                Descargar: {{ oReduccion.oPeriodo.oVerificacion.sNombre }}
                            </span>
                        </ng-template>
                    </a>
                </div>

                <mat-error class="text-center" *ngIf="fileLineaBaseInvalid && fileLineaBaseTooLarge">El archivo es
                    mayor de
                    5mb.</mat-error>
                <mat-error class="text-center" *ngIf="fileLineaBaseInvalid && !fileLineaBaseTooLarge">Suba un archivo
                    válido.</mat-error>

            </div>
            <div class="col-md-6">
                <p class="text-center mt-3 mt-md-0">Año de reducción:
                    <span class="fc-black fw-600">
                        <ng-container *ngIf="modal.oVerificacion != null; else elseAnio">
                            {{modal.nAnio}}
                        </ng-container>
                        <ng-template #elseAnio>
                            <ng-container *ngIf="modal.nAnio">
                                {{modal.nAnio}}
                            </ng-container>
                        </ng-template>
                    </span>

                </p>
                <input accept=".pdf" type="file" id="fileAnioReduccion"
                    (change)="onFileChange($event, 'fileAnioReduccion')" style="display: none;">
                <label [ngClass]="{'dragging': draggingAnioReduccion}" for="fileAnioReduccion" class="solicitud_file"
                    (dragleave)="draggingAnioReduccion = false" (dragover)="handleDragOver($event, 'fileAnioReduccion')"
                    (drop)="handleDrop($event, 'fileAnioReduccion')">
                    <mat-icon *ngIf="!draggingAnioReduccion && !isUploadedAnioReduccion" aria-hidden="false"
                        aria-label="cloud_upload" fontIcon="cloud_upload"
                        style="font-size: 32px; height: 32px; width: 32px;"></mat-icon>
                    <mat-icon *ngIf="draggingAnioReduccion" aria-hidden="false" aria-label="cloud_download"
                        fontIcon="cloud_download" style="font-size: 32px; height: 32px; width: 32px;"></mat-icon>
                    <mat-icon *ngIf="isUploadedAnioReduccion && !draggingAnioReduccion" aria-hidden="false"
                        aria-label="check_circle" fontIcon="check_circle"
                        style="font-size: 32px; height: 32px; width: 32px;"></mat-icon>
                    <div *ngIf="!draggingAnioReduccion && !isUploadedAnioReduccion" class="solicitud_file--text mt-1">
                        Seleccione para cargar o arrastrar y soltar aquí
                        <br>
                        <span class="mt-3">Archivo permitido en PDF y máximo de 5 mb</span>
                    </div>
                    <div *ngIf="isUploadedAnioReduccion && !draggingAnioReduccion" class="mt-1">
                        <span class="solicitud_file--archivo fs-14">Archivo: {{ nombreArchivoAnioReduccion }}</span>
                    </div>
                    <span *ngIf="draggingAnioReduccion" class="solicitud_file--text mt-1">Soltar archivo</span>
                </label>


                <!-- Descarga de documento -->
                <div *ngIf="oReduccion.oDocRequisito.sCodigoDocumento" class="d-flex justify-content-center mt-2">
                    <a class="text-primary text-decoration-underline pointer" (click)="fnDescargaCertificado(2)">
                        Descargar: {{ oReduccion.oDocRequisito.sNombre }}
                    </a>
                </div>

                <mat-error class="text-center" *ngIf="fileAnioReduccionInvalid && fileAnioReduccionTooLarge">El archivo
                    es mayor de
                    5mb.</mat-error>
                <mat-error class="text-center" *ngIf="fileAnioReduccionInvalid && !fileAnioReduccionTooLarge">Suba un
                    archivo
                    válido.</mat-error>

            </div>
        </div>
    </mat-dialog-content>
    <mat-dialog-actions class="d-flex justify-content-end w-100">
        <button mat-button mat-dialog-close>Cancelar</button>
        <button [disabled]="loadingModal" mat-flat-button (click)="fnRegistrarReduccion()">
            <mat-icon *ngIf="loadingModal"><mat-spinner color="primary" diameter="16"></mat-spinner></mat-icon>Guardar
        </button>
    </mat-dialog-actions>
</ng-template>

<!-- Modal requisitos compensación/neutralización-->
<ng-template #modalReqCompensacion>
    <form [formGroup]="formReqCompensacion" (ngSubmit)="fnRegistrarCompensacion()">

        <h2 mat-dialog-title class="fw-500 pluto_normal text-center">
            Nivel de Compensación/Neutralización
            <button mat-icon-button mat-dialog-close class="close-button">
                <mat-icon>close</mat-icon>
            </button>
        </h2>
        <mat-dialog-content>
            <!--   {{this.modal.bdTotalEmisiones}} -->
            <div class="row">
                <div class="col-md-12 mt-2">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Bonos de carbono comprados (tCO<sub>2</sub>e)</mat-label>
                        <input matInput type="text" formControlName="bonosCarbono" required
                            oninput="this.value = this.value.replace(/[^0-9]/g, ''); this.value = this.value.slice(0, 10);" />
                        <!--  <mat-error *ngIf="formReqCompensacion.get('bonosCarbono')?.hasError('required')">
                            Este campo es obligatorio.
                        </mat-error>
                        <mat-error *ngIf="formReqCompensacion.get('bonosCarbono')?.hasError('maxlength')">
                            El valor máximo permitido es de 10 dígitos.
                        </mat-error>
                        <mat-error *ngIf="formReqCompensacion.get('bonosCarbono')?.hasError('pattern')">
                            Solo se permiten valores enteros.
                        </mat-error> -->
                    </mat-form-field>
                </div>
                <div class="col-md-12">
                    <label class="text-start mb-1 fw-500 fs-14 pluto_normal">Certificado de bonos de carbono
                        comprados</label>
                    <label class="text-start mb-2 fw-400" style="color:#666666">
                        Certificado con al menos el {{porcentajeCompensadoRequerido}}% de emisiones compensadas
                    </label>
                    <input accept=".pdf" type="file" id="fileCompensacion"
                        (change)="onFileChange($event, 'fileCompensacion')" style="display: none;">
                    <label [ngClass]="{'dragging': draggingCompensacion}" for="fileCompensacion" class="solicitud_file"
                        (dragleave)="draggingCompensacion = false"
                        (dragover)="handleDragOver($event, 'fileCompensacion')"
                        (drop)="handleDrop($event, 'fileCompensacion')">
                        <mat-icon *ngIf="!draggingCompensacion && !isUploadedCompensacion" aria-hidden="false"
                            aria-label="cloud_upload" fontIcon="cloud_upload"
                            style="font-size: 32px; height: 32px; width: 32px;"></mat-icon>
                        <mat-icon *ngIf="draggingCompensacion" aria-hidden="false" aria-label="cloud_download"
                            fontIcon="cloud_download" style="font-size: 32px; height: 32px; width: 32px;"></mat-icon>
                        <mat-icon *ngIf="isUploadedCompensacion && !draggingCompensacion" aria-hidden="false"
                            aria-label="check_circle" fontIcon="check_circle"
                            style="font-size: 32px; height: 32px; width: 32px;"></mat-icon>
                        <div *ngIf="!draggingCompensacion && !isUploadedCompensacion" class="solicitud_file--text mt-1">
                            Seleccione para cargar o arrastrar y soltar aquí
                            <br>
                            <span class="mt-3">Archivo permitido en PDF y máximo de 5 mb</span>
                        </div>
                        <div *ngIf="isUploadedCompensacion && !draggingCompensacion" class="mt-1">
                            <span class="solicitud_file--archivo fs-14">Archivo: {{ nombreArchivoCompensacion }}</span>
                        </div>
                        <span *ngIf="draggingCompensacion" class="solicitud_file--text mt-1">Soltar archivo</span>
                    </label>

                    <!-- Descarga de documento -->
                    <div *ngIf="oCompensacion.oDocRequisito.sCodigoDocumento"
                        class="d-flex justify-content-center mt-2">
                        <a class="text-primary text-decoration-underline pointer" (click)="fnDescargaCertificado(3)">
                            <!--    Descargar certificado -->
                            Descargar: {{ oCompensacion.oDocRequisito.sNombre }}
                        </a>
                    </div>


                    <mat-error *ngIf="fileCompensacionInvalid && fileCompensacionTooLarge">El archivo es mayor de
                        5mb.</mat-error>
                    <mat-error *ngIf="fileCompensacionInvalid && !fileCompensacionTooLarge">Suba un archivo
                        válido.</mat-error>
                </div>
            </div>
        </mat-dialog-content>
        <mat-dialog-actions class="d-flex justify-content-end w-100">
            <button mat-button mat-dialog-close>Cancelar</button>
            <button [disabled]="loadingModal" mat-flat-button type="submit">
                <mat-icon *ngIf="loadingModal"><mat-spinner color="primary" diameter="16"></mat-spinner></mat-icon>
                Guardar
            </button>
        </mat-dialog-actions>
    </form>
</ng-template>


<!-- Modal informativo -->
<ng-template #modalInformativo>
    <h2 mat-dialog-title class="fw-500 pluto_normal text-center">Mensaje informativo
    </h2>
    <div mat-dialog-content>
        <p class="text-center">{{mensajeInformativo}}</p>
    </div>
    <div mat-dialog-actions>
        <button mat-flat-button mat-dialog-close color="primary">
            Aceptar</button>
    </div>
</ng-template>

<!-- Modal observación reconocimiento -->
<ng-template #modalObsReconocimiento>
    <h2 mat-dialog-title class="fw-500 pluto_normal text-center">Observación </h2>
    <div mat-dialog-content>
        <p class="text-center">{{obsReconocimiento}}</p>
    </div>
    <div mat-dialog-actions>
        <button mat-flat-button mat-dialog-close color="primary">
            Aceptar</button>
    </div>
</ng-template>